name: Build and Test

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'

jobs:
  build-and-test:
    runs-on: windows-latest
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: 'af752f21c9d79ba3df9cb0250ce2233933f58486'
        
    - name: Install dependencies
      run: vcpkg install

    - name: Build (Debug x64)
      run: msbuild .\src\lastexecrecord.sln /m /p:Configuration=Debug /p:Platform=x64

    - name: Run tests (MSTest)
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'

        $testDll = Get-ChildItem -Path "$env:GITHUB_WORKSPACE\src" -Recurse -Filter "lastexecuterecord.mstest.dll" |
          Select-Object -First 1
        if (-not $testDll) {
          throw "Test DLL not found: lastexecuterecord.mstest.dll"
        }

        $vswhere = Join-Path ${env:ProgramFiles(x86)} "Microsoft Visual Studio\Installer\vswhere.exe"
        if (-not (Test-Path $vswhere)) {
          throw "vswhere.exe not found at $vswhere"
        }

        $vsInstallPath = & $vswhere -latest -products * -requires Microsoft.VisualStudio.PackageGroup.TestTools.Core -property installationPath
        if (-not $vsInstallPath) {
          $vsInstallPath = & $vswhere -latest -products * -property installationPath
        }
        if (-not $vsInstallPath) {
          throw "Visual Studio installation not found (vswhere returned empty)."
        }

        $vstestCandidates = @(
          (Join-Path $vsInstallPath "Common7\IDE\Extensions\TestPlatform\vstest.console.exe"),
          (Join-Path $vsInstallPath "Common7\IDE\CommonExtensions\Microsoft\TestWindow\vstest.console.exe")
        ) | Where-Object { Test-Path $_ }

        if ($vstestCandidates.Count -eq 0) {
          throw "vstest.console.exe not found under: $vsInstallPath"
        }

        $vstest = $vstestCandidates[0]
        & $vstest $testDll.FullName /Platform:x64 /InIsolation /Logger:trx

    - name: Build (Release x64)
      run: msbuild .\src\lastexecrecord.sln /m /p:Configuration=Release /p:Platform=x64

